<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Pomodoro Focus Timer Light</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --accent-focus: #0ea5e9;   /* sky-500 */
      --accent-break-short: #22c55e; /* emerald-500 */
      --accent-break-long: #f97316;  /* orange-500 */
      --ring-base: #e5e7eb;
    }

    body {
      background: radial-gradient(circle at top, #f1f5f9 0, #e5e7eb 35%, #f9fafb 100%);
    }

    /* æ¯ç§’ãƒã‚³ãƒƒã¨å¼¾ã‚€ */
    @keyframes tick-pop {
      0%   { transform: scale(1); }
      25%  { transform: scale(1.04); }
      100% { transform: scale(1); }
    }
    .tick-pop {
      animation: tick-pop 0.25s ease-out;
    }

    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ãƒ•ã‚§ãƒ¼ãƒ‰ */
    @keyframes mode-fade {
      0%   { opacity: 0; transform: translateY(6px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .mode-fade {
      animation: mode-fade 0.3s ease-out;
    }

    /* ã†ã£ã™ã‚‰å‹•ãã‚°ãƒªãƒƒãƒ‰èƒŒæ™¯ */
    .bg-grid {
      position: absolute;
      inset: -1px;
      background-image:
        linear-gradient(to right, rgba(148,163,184,0.16) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(148,163,184,0.16) 1px, transparent 1px);
      background-size: 24px 24px;
      mask-image: radial-gradient(circle at center, black 0, transparent 70%);
      opacity: 0.55;
      pointer-events: none;
      animation: grid-move 26s linear infinite;
    }
    @keyframes grid-move {
      0%   { background-position: 0 0, 0 0; }
      100% { background-position: 48px 48px, 48px 48px; }
    }

    /* ã‚«ãƒ¼ãƒ‰å†…ã®æ·¡ã„å…‰ */
    .animated-glow {
      animation: bg-glow 22s ease-in-out infinite;
    }
    @keyframes bg-glow {
      0%   { opacity: 0.35; transform: translate3d(0,0,0) scale(1); }
      50%  { opacity: 0.75; transform: translate3d(10px, -6px, 0) scale(1.03); }
      100% { opacity: 0.35; transform: translate3d(0,0,0) scale(1); }
    }

    /* ã‚¿ã‚¤ãƒãƒ¼ãƒªãƒ³ã‚° */
    #progressRing {
      box-shadow: 0 0 0 0 rgba(148,163,184,0.2);
      transition:
        box-shadow 0.35s ease-out,
        transform 0.25s ease-out,
        background 0.4s linear;
    }
    #progressRing.is-running {
      animation: ring-pulse 1.4s ease-out infinite;
      transform: translateY(-1px);
    }
    @keyframes ring-pulse {
      0%   { box-shadow: 0 0 0 0 rgba(14,165,233,0.1); }
      50%  { box-shadow: 0 0 32px 10px rgba(14,165,233,0.35); }
      100% { box-shadow: 0 0 0 0 rgba(14,165,233,0.1); }
    }

    /* ãƒœã‚¿ãƒ³å…±é€šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    button {
      transition:
        transform 0.16s ease-out,
        box-shadow 0.18s ease-out,
        background-color 0.16s ease-out,
        border-color 0.16s ease-out,
        opacity 0.16s ease-out;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(15,23,42,0.16);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 14px rgba(15,23,42,0.18);
    }
  </style>
</head>
<body class="min-h-screen text-slate-900 flex items-center justify-center">
  <div class="w-full max-w-3xl mx-4 my-8 relative">
    <!-- èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ -->
    <div class="bg-grid"></div>

    <div class="relative bg-white/90 border border-slate-200 rounded-3xl shadow-[0_26px_70px_rgba(15,23,42,0.14)] backdrop-blur-xl p-6 md:p-8 overflow-hidden">
      <!-- ã¼ã‚“ã‚„ã‚Šã—ãŸè‰²ã®ã«ã˜ã¿ -->
      <div class="pointer-events-none absolute -inset-16 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),transparent_60%),radial-gradient(circle_at_bottom,_rgba(248,113,113,0.18),transparent_60%)] opacity-80 animated-glow"></div>

      <div class="relative space-y-5 md:space-y-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="space-y-2">
            <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
              Pomodoro Focus Timer<span class="text-sky-500"> Light</span>
            </h1>
            <p class="text-xs md:text-sm text-slate-600 leading-relaxed">
              <span class="font-semibold text-slate-800">é›†ä¸­</span>ãƒ»
              <span class="font-semibold text-slate-800">å°ä¼‘æ†©</span>ãƒ»
              <span class="font-semibold text-slate-800">é•·ä¼‘æ†©</span> ã‚’è‰²ã§åˆ†ã‘ã¦è¡¨ç¤ºã€‚<br class="md:hidden" />
              ã€Œä»Šãªã«ãƒ¢ãƒ¼ãƒ‰ãªã®ã‹ã€ãŒä¸€ç›®ã§ã‚ã‹ã‚‹ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒç‰ˆã€‚
            </p>

            <!-- ã‚¿ã‚¹ã‚¯å…¥åŠ› -->
            <div class="flex items-center gap-2 text-xs md:text-sm">
              <span class="px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-700">
                ä»Šã‚„ã‚‹ã“ã¨
              </span>
              <input id="taskInput"
                     type="text"
                     maxlength="40"
                     placeholder="ä¾‹: æ•°å­¦ã®ãƒ¯ãƒ¼ã‚¯ / è‹±å˜èª50å€‹ / ã‚³ãƒ¼ãƒ‰ä¿®æ­£"
                     class="flex-1 bg-white/80 border border-slate-300 rounded-2xl px-3 py-1.5 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/80 placeholder:text-slate-400" />
            </div>
            <p id="taskCurrentLabel" class="text-[11px] text-slate-500">
              ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ï¼šæœªè¨­å®š
            </p>
          </div>

          <div class="flex flex-col items-end gap-2 text-right">
            <span id="modeChip"
                  class="inline-flex items-center gap-1.5 text-[11px] px-3 py-1.5 rounded-full bg-slate-100 border border-slate-300">
              <span class="w-2 h-2 rounded-full bg-sky-400 animate-pulse"></span>
              <span id="modeChipLabel" class="font-medium text-slate-700">é›†ä¸­ãƒ¢ãƒ¼ãƒ‰</span>
            </span>
            <p id="nextLabel" class="text-[11px] text-slate-500">
              æ¬¡ï¼šçŸ­ã„ä¼‘æ†©ï¼ˆ5åˆ†ï¼‰
            </p>

            <!-- ãƒ‡ã‚¤ãƒªãƒ¼ç›®æ¨™ -->
            <div class="mt-1 flex flex-col items-end gap-1 text-[11px] text-slate-700">
              <div class="flex items-center gap-1.5">
                <span>ä»Šæ—¥ã®ç›®æ¨™</span>
                <input id="dailyTargetInput"
                       type="number"
                       min="1"
                       max="20"
                       value="8"
                       class="w-14 bg-white border border-slate-300 rounded-xl px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-sky-400/80" />
                <span>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</span>
              </div>
              <div class="w-40 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="dailyProgressFill"
                     class="h-full w-0 bg-gradient-to-r from-sky-400 via-emerald-400 to-amber-400 transition-all duration-500"></div>
              </div>
              <span id="dailyProgressText" class="text-[10px] text-slate-500">
                0 / 8 é”æˆ
              </span>
            </div>
          </div>
        </header>

        <!-- Mode Tabs -->
        <section class="mode-fade">
          <div class="grid grid-cols-3 gap-2 text-xs md:text-sm">
            <button
              class="mode-tab px-3 py-2.5 rounded-2xl border bg-sky-50 border-sky-300 shadow-[0_0_12px_rgba(56,189,248,0.25)] flex flex-col items-start justify-center gap-0.5 transition"
              data-mode="pomodoro">
              <span class="font-semibold text-slate-800">ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</span>
              <span class="text-[11px] text-sky-700 flex items-center gap-1">
                <span>é›†ä¸­</span><span>ğŸ”µ</span>
              </span>
            </button>
            <button
              class="mode-tab px-3 py-2.5 rounded-2xl border bg-white border-slate-200 flex flex-col items-start justify-center gap-0.5 transition"
              data-mode="short">
              <span class="font-semibold text-slate-800">çŸ­ã„ä¼‘æ†©</span>
              <span class="text-[11px] text-emerald-700 flex items-center gap-1">
                <span>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥</span><span>â˜•</span>
              </span>
            </button>
            <button
              class="mode-tab px-3 py-2.5 rounded-2xl border bg-white border-slate-200 flex flex-col items-start justify-center gap-0.5 transition"
              data-mode="long">
              <span class="font-semibold text-slate-800">é•·ã„ä¼‘æ†©</span>
              <span class="text-[11px] text-orange-700 flex items-center gap-1">
                <span>ã—ã£ã‹ã‚Šä¼‘ã‚€</span><span>ğŸ›</span>
              </span>
            </button>
          </div>
        </section>

        <!-- Timer & progress -->
        <section class="flex flex-col md:flex-row md:items-center md:justify-between gap-5 md:gap-6">
          <!-- Timer circle -->
          <div class="flex-1 flex flex-col items-center gap-3">
            <div class="text-xs text-slate-500 mb-1">
              æ®‹ã‚Šæ™‚é–“
            </div>

            <div id="progressRing"
                 class="relative w-56 h-56 md:w-64 md:h-64 rounded-full flex items-center justify-center transition-all duration-300 bg-[conic-gradient(#0ea5e9_0deg,var(--ring-base)_0deg)] border border-slate-200 overflow-hidden">
              <!-- å†…å´ã®å†† -->
              <div class="absolute inset-[13%] rounded-full bg-white border border-slate-200 shadow-inner"></div>

              <!-- ä¸­å¤®ã®æ™‚é–“è¡¨ç¤º -->
              <div class="relative flex flex-col items-center justify-center">
                <div id="timerText"
                     class="font-mono text-5xl md:text-6xl font-semibold tracking-tight tabular-nums select-none text-slate-900">
                  25:00
                </div>
                <div id="statusText"
                     class="mt-3 text-xs md:text-sm text-slate-600 text-center">
                  ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã®æº–å‚™OK
                </div>
              </div>
            </div>

            <!-- ä¸‹ã®é€²æ—ãƒãƒ¼ï¼ˆè¦–è¦šçš„ã«æ®‹ã‚ŠãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ï¼‰ -->
            <div class="w-full max-w-xs mt-3">
              <div class="flex items-center justify-between text-[11px] text-slate-500 mb-1">
                <span>é€²è¡ŒçŠ¶æ³</span>
                <span id="progressPercentLabel">0%</span>
              </div>
              <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                <div id="linearProgress"
                     class="h-full w-0 bg-gradient-to-r from-sky-400 via-emerald-400 to-amber-400 transition-all duration-300 ease-out"></div>
              </div>
            </div>

            <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ -->
            <div class="mt-3 text-xs md:text-sm text-slate-600 flex flex-col items-center gap-1.5">
              <span id="sessionsLabel">ä»Šæ—¥ã®ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼š0å›</span>
              <div id="sessionDots" class="flex gap-1.5 flex-wrap justify-center">
                <!-- JSã§ä¸¸ã‚’è¿½åŠ  -->
              </div>
            </div>
          </div>

          <!-- Controls & options -->
          <div class="flex-1 space-y-4">
            <!-- Controls -->
            <div class="flex flex-col gap-2">
              <div class="flex flex-col md:flex-row gap-2">
                <button id="startPauseBtn"
                        class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-sky-500 hover:bg-sky-400 text-white font-semibold text-sm md:text-base transition">
                  â–¶ é–‹å§‹
                </button>
                <button id="resetBtn"
                        class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-white hover:bg-slate-50 text-slate-800 text-xs md:text-sm font-medium border border-slate-300 transition">
                  ãƒªã‚»ãƒƒãƒˆ
                </button>
              </div>
              <button id="skipBtn"
                      class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-2xl bg-slate-50 hover:bg-slate-100 text-slate-800 text-xs md:text-sm font-medium border border-slate-300 transition">
                â­ ä»Šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
              </button>
            </div>

            <!-- Options -->
            <div class="text-[11px] md:text-xs text-slate-700 space-y-3 border border-slate-200 rounded-2xl p-3 bg-slate-50/80">
              <div class="flex items-center justify-between gap-2">
                <label class="flex items-center gap-2">
                  <input id="soundToggle" type="checkbox" class="accent-sky-500" checked />
                  <span>çµ‚äº†æ™‚ã«ãƒ“ãƒ¼ãƒ—éŸ³ã‚’é³´ã‚‰ã™</span>
                </label>
                <label class="flex items-center gap-2">
                  <input id="autoStartToggle" type="checkbox" class="accent-sky-500" />
                  <span>è‡ªå‹•ã§æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</span>
                </label>
              </div>
              <div class="flex items-center justify-between gap-2">
                <span class="text-slate-500">
                  ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼š
                  <span class="text-slate-700">Space</span> é–‹å§‹/ä¸€æ™‚åœæ­¢ã€
                  <span class="text-slate-700">R</span> ãƒªã‚»ãƒƒãƒˆ
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section class="space-y-4 text-xs md:text-sm text-slate-700 border border-slate-200 rounded-2xl p-3 md:p-4 bg-slate-50/80">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-semibold text-sm md:text-base">ã‚¿ã‚¤ãƒãƒ¼è¨­å®šï¼ˆåˆ†ãƒ»ç§’å¯¾å¿œï¼‰</h2>
            <button id="applySettingsBtn"
                    class="px-3 py-1.5 rounded-xl bg-white hover:bg-slate-50 border border-slate-300 text-[11px] md:text-xs">
              è¨­å®šã‚’åæ˜ 
            </button>
          </div>

          <div class="space-y-3">
            <!-- Pomodoro -->
            <div class="flex items-center justify-between gap-3">
              <span class="w-24 md:w-28 font-medium text-slate-800">ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</span>
              <div class="flex items-center gap-1.5">
                <input id="pomodoroMin" type="number" min="0" max="600" value="25"
                       class="w-16 bg-white border border-slate-300 rounded-xl px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-sky-400/80" />
                <span class="text-[11px] text-slate-500">åˆ†</span>
                <input id="pomodoroSec" type="number" min="0" max="59" value="0"
                       class="w-16 bg-white border border-slate-300 rounded-xl px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-sky-400/80" />
                <span class="text-[11px] text-slate-500">ç§’</span>
              </div>
            </div>

            <!-- Short break -->
            <div class="flex items-center justify-between gap-3">
              <span class="w-24 md:w-28 font-medium text-slate-800">çŸ­ã„ä¼‘æ†©</span>
              <div class="flex items-center gap-1.5">
                <input id="shortMin" type="number" min="0" max="600" value="5"
                       class="w-16 bg-white border border-slate-300 rounded-xl px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-sky-400/80" />
                <span class="text-[11px] text-slate-500">åˆ†</span>
                <input id="shortSec" type="number" min="0" max="59" value="0"
                       class="w-16 bg-white border border-slate-300 rounded-xl px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-sky-400/80" />
                <span class="text-[11px] text-slate-500">ç§’</span>
              </div>
            </div>

            <!-- Long break -->
            <div class="flex items-center justify-between gap-3">
              <span class="w-24 md:w-28 font-medium text-slate-800">é•·ã„ä¼‘æ†©</span>
              <div class="flex items-center gap-1.5">
                <input id="longMin" type="number" min="0" max="600" value="15"
                       class="w-16 bg-white border border-slate-300 rounded-xl px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-sky-400/80" />
                <span class="text-[11px] text-slate-500">åˆ†</span>
                <input id="longSec" type="number" min="0" max="59" value="0"
                       class="w-16 bg-white border border-slate-300 rounded-xl px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-sky-400/80" />
                <span class="text-[11px] text-slate-500">ç§’</span>
              </div>
            </div>
          </div>

          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 pt-2 border-t border-slate-200">
            <div class="flex items-center gap-2">
              <span class="text-slate-700">é•·ã„ä¼‘æ†©ã«å…¥ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</span>
              <div class="flex items-center gap-1.5">
                <input id="longIntervalInput" type="number" min="1" max="12" value="4"
                       class="w-16 bg-white border border-slate-300 rounded-xl px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-sky-400/80" />
                <span class="text-[11px] text-slate-500">ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã”ã¨</span>
              </div>
            </div>
            <p id="infoHint" class="text-[11px] text-slate-500">
              é•·ã„ä¼‘æ†©ï¼šãƒãƒ¢ãƒ‰ãƒ¼ãƒ­4å›ã”ã¨
            </p>
          </div>
        </section>

        <footer class="pt-1 text-[11px] text-slate-500 text-center">
          ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼š
          <span class="text-slate-700">ã€ŒçŸ­ã„é›†ä¸­ Ã— ä¼‘æ†©ã€ã‚’ç¹°ã‚Šè¿”ã—ã¦ã€é›†ä¸­åŠ›ã‚’é•·æŒã¡ã•ã›ã‚‹æ–¹æ³•ã€‚</span>
        </footer>
      </div>
    </div>
  </div>

  <script>
    // ===== ãƒ¢ãƒ¼ãƒ‰è¨­å®š =====
    const modeConfig = {
      pomodoro: {
        key: "pomodoro",
        name: "ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­",
        chipText: "é›†ä¸­ãƒ¢ãƒ¼ãƒ‰",
        runningText: "é›†ä¸­ã‚¿ã‚¤ãƒ ä¸­",
        idleText: "ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã®æº–å‚™OK",
        color: "var(--accent-focus)"
      },
      short: {
        key: "short",
        name: "çŸ­ã„ä¼‘æ†©",
        chipText: "ä¼‘æ†©ãƒ¢ãƒ¼ãƒ‰",
        runningText: "çŸ­ã„ä¼‘æ†©ä¸­",
        idleText: "çŸ­ã„ä¼‘æ†©ã®æº–å‚™OK",
        color: "var(--accent-break-short)"
      },
      long: {
        key: "long",
        name: "é•·ã„ä¼‘æ†©",
        chipText: "ä¼‘æ†©ãƒ¢ãƒ¼ãƒ‰",
        runningText: "é•·ã„ä¼‘æ†©ä¸­",
        idleText: "é•·ã„ä¼‘æ†©ã®æº–å‚™OK",
        color: "var(--accent-break-long)"
      }
    };

    // ===== çŠ¶æ…‹å¤‰æ•° =====
    let durations = {
      pomodoro: 25 * 60,
      short: 5 * 60,
      long: 15 * 60
    };

    let currentModeKey = "pomodoro";
    let totalSeconds = durations[currentModeKey];
    let remainingSeconds = totalSeconds;
    let isRunning = false;
    let timerId = null;
    let completedPomodoros = 0;
    let longBreakInterval = 4;
    let dailyTarget = 8;

    // ===== DOM =====
    const timerTextEl        = document.getElementById("timerText");
    const statusTextEl       = document.getElementById("statusText");
    const progressRingEl     = document.getElementById("progressRing");
    const linearProgressEl   = document.getElementById("linearProgress");
    const progressPercentEl  = document.getElementById("progressPercentLabel");
    const startPauseBtn      = document.getElementById("startPauseBtn");
    const resetBtn           = document.getElementById("resetBtn");
    const skipBtn            = document.getElementById("skipBtn");
    const modeTabs           = document.querySelectorAll(".mode-tab");
    const modeChipLabelEl    = document.getElementById("modeChipLabel");
    const nextLabelEl        = document.getElementById("nextLabel");
    const sessionDotsEl      = document.getElementById("sessionDots");
    const sessionsLabelEl    = document.getElementById("sessionsLabel");
    const applySettingsBtn   = document.getElementById("applySettingsBtn");
    const soundToggle        = document.getElementById("soundToggle");
    const autoStartToggle    = document.getElementById("autoStartToggle");
    const infoHintEl         = document.getElementById("infoHint");
    const dailyTargetInput   = document.getElementById("dailyTargetInput");
    const dailyProgressFill  = document.getElementById("dailyProgressFill");
    const dailyProgressText  = document.getElementById("dailyProgressText");
    const taskInput          = document.getElementById("taskInput");
    const taskCurrentLabel   = document.getElementById("taskCurrentLabel");

    // è¨­å®š input
    const pomodoroMinInput   = document.getElementById("pomodoroMin");
    const pomodoroSecInput   = document.getElementById("pomodoroSec");
    const shortMinInput      = document.getElementById("shortMin");
    const shortSecInput      = document.getElementById("shortSec");
    const longMinInput       = document.getElementById("longMin");
    const longSecInput       = document.getElementById("longSec");
    const longIntervalInput  = document.getElementById("longIntervalInput");

    // ===== Utility =====
    function formatTime(sec) {
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateTimerDisplay() {
      timerTextEl.textContent = formatTime(remainingSeconds);
    }

    function updateModeTabs() {
      modeTabs.forEach(btn => {
        const key = btn.dataset.mode;
        const isActive = key === currentModeKey;
        if (isActive) {
          btn.classList.remove("bg-white", "border-slate-200", "shadow-none");
          if (key === "pomodoro") {
            btn.classList.add(
              "bg-sky-50",
              "border-sky-300",
              "shadow-[0_0_12px_rgba(56,189,248,0.25)]"
            );
          } else if (key === "short") {
            btn.classList.add(
              "bg-emerald-50",
              "border-emerald-300",
              "shadow-[0_0_12px_rgba(16,185,129,0.25)]"
            );
          } else {
            btn.classList.add(
              "bg-orange-50",
              "border-orange-300",
              "shadow-[0_0_12px_rgba(249,115,22,0.25)]"
            );
          }
        } else {
          btn.classList.remove(
            "bg-sky-50", "border-sky-300",
            "bg-emerald-50", "border-emerald-300",
            "bg-orange-50", "border-orange-300",
            "shadow-[0_0_12px_rgba(56,189,248,0.25)]",
            "shadow-[0_0_12px_rgba(16,185,129,0.25)]",
            "shadow-[0_0_12px_rgba(249,115,22,0.25)]"
          );
          btn.classList.add("bg-white", "border-slate-200");
        }
      });
    }

    function updateProgressVisual() {
      const cfg = modeConfig[currentModeKey];
      const color = cfg.color;
      const base = "var(--ring-base)";
      let ratio = totalSeconds > 0 ? remainingSeconds / totalSeconds : 0;
      ratio = Math.min(1, Math.max(0, ratio));
      const progress = 1 - ratio;
      const deg = progress * 360;

      progressRingEl.style.background =
        `conic-gradient(${color} ${deg}deg, ${base} ${deg}deg)`;

      // ä¸‹ã®æ¨ªãƒãƒ¼
      const percent = Math.round(progress * 100);
      linearProgressEl.style.width = `${percent}%`;
      progressPercentEl.textContent = `${percent}%`;
    }

    function updateSessionDots() {
      sessionDotsEl.innerHTML = "";
      const maxDots = 10;
      const count = Math.min(maxDots, dailyTarget || maxDots);
      for (let i = 0; i < count; i++) {
        const dot = document.createElement("div");
        const filled = i < completedPomodoros;
        dot.className =
          "w-3 h-3 rounded-full " +
          (filled
            ? "bg-sky-400 shadow-[0_0_8px_rgba(56,189,248,0.7)]"
            : "bg-slate-100 border border-slate-300");
        sessionDotsEl.appendChild(dot);
      }
      sessionsLabelEl.textContent = `ä»Šæ—¥ã®ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼š${completedPomodoros}å›`;
      updateDailyProgress();
    }

    function updateDailyProgress() {
      let target = dailyTarget;
      if (!target || target < 1) target = 1;
      const ratio = Math.min(1, completedPomodoros / target);
      dailyProgressFill.style.width = `${ratio * 100}%`;
      dailyProgressText.textContent = `${completedPomodoros} / ${dailyTarget} é”æˆ`;
    }

    function updateStatusUI() {
      const cfg = modeConfig[currentModeKey];
      modeChipLabelEl.textContent = cfg.chipText;
      statusTextEl.textContent = isRunning ? cfg.runningText : cfg.idleText;

      const nextKey = predictNextMode();
      if (nextKey) {
        const mins = Math.floor(durations[nextKey] / 60);
        nextLabelEl.textContent = `æ¬¡ï¼š${modeConfig[nextKey].name}ï¼ˆ${mins}åˆ†ï¼‰`;
      } else {
        nextLabelEl.textContent = "";
      }

      infoHintEl.textContent = `é•·ã„ä¼‘æ†©ï¼šãƒãƒ¢ãƒ‰ãƒ¼ãƒ­${longBreakInterval}å›ã”ã¨`;
    }

    function predictNextMode() {
      if (currentModeKey === "pomodoro") {
        const nextCount = completedPomodoros + 1;
        if (nextCount > 0 && nextCount % longBreakInterval === 0) {
          return "long";
        }
        return "short";
      } else {
        return "pomodoro";
      }
    }

    function playBeep() {
      if (!soundToggle.checked) return;
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.setValueAtTime(0.0, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.45);

        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
      } catch (e) {
        // å¤±æ•—ã—ã¦ã‚‚ä½•ã‚‚ã—ãªã„
      }
    }

    function pulseTimer() {
      timerTextEl.classList.remove("tick-pop");
      void timerTextEl.offsetWidth; // reflow
      timerTextEl.classList.add("tick-pop");
    }

    function startTimer() {
      if (isRunning) return;
      if (remainingSeconds <= 0) {
        remainingSeconds = totalSeconds;
      }
      isRunning = true;
      startPauseBtn.textContent = "â¸ ä¸€æ™‚åœæ­¢";
      if (timerId) clearInterval(timerId);
      timerId = setInterval(tick, 1000);
      progressRingEl.classList.add("is-running");
      updateStatusUI();
      updateProgressVisual();
    }

    function pauseTimer() {
      if (!isRunning) return;
      isRunning = false;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      startPauseBtn.textContent = "â–¶ å†é–‹";
      progressRingEl.classList.remove("is-running");
      updateStatusUI();
      updateProgressVisual();
    }

    function resetTimer() {
      pauseTimer();
      remainingSeconds = totalSeconds;
      startPauseBtn.textContent = "â–¶ é–‹å§‹";
      updateTimerDisplay();
      updateProgressVisual();
      updateStatusUI();
    }

    function switchMode(newKey, resetRemaining = true) {
      currentModeKey = newKey;
      totalSeconds = durations[newKey];
      if (resetRemaining) {
        remainingSeconds = totalSeconds;
      }
      updateTimerDisplay();
      updateModeTabs();
      updateProgressVisual();
      updateStatusUI();
    }

    function tick() {
      if (!isRunning) return;
      if (remainingSeconds <= 0) {
        handleFinish(false);
        return;
      }
      remainingSeconds -= 1;
      updateTimerDisplay();
      updateProgressVisual();
      pulseTimer();
    }

    function handleFinish(skipped) {
      pauseTimer();
      if (!skipped) {
        playBeep();
      }

      const fromKey = currentModeKey;

      if (fromKey === "pomodoro" && !skipped) {
        completedPomodoros += 1;
        updateSessionDots();
      }

      let nextKey;
      if (fromKey === "pomodoro") {
        if (!skipped && completedPomodoros > 0 && completedPomodoros % longBreakInterval === 0) {
          nextKey = "long";
        } else {
          nextKey = "short";
        }
      } else {
        nextKey = "pomodoro";
      }

      remainingSeconds = 0;
      updateTimerDisplay();
      updateProgressVisual();

      switchMode(nextKey, true);
      startPauseBtn.textContent = "â–¶ é–‹å§‹";

      if (autoStartToggle.checked) {
        startTimer();
      }
    }

    function applySettings() {
      function getDuration(minEl, secEl, defaultMin) {
        const mins = parseInt(minEl.value, 10);
        const secs = parseInt(secEl.value, 10);
        let total = 0;
        if (!isNaN(mins) && mins >= 0) total += mins * 60;
        if (!isNaN(secs) && secs >= 0) total += secs;
        if (total <= 0) total = defaultMin * 60;
        return total;
      }

      durations.pomodoro = getDuration(pomodoroMinInput, pomodoroSecInput, 25);
      durations.short    = getDuration(shortMinInput, shortSecInput, 5);
      durations.long     = getDuration(longMinInput, longSecInput, 15);

      let interval = parseInt(longIntervalInput.value, 10);
      if (isNaN(interval) || interval < 1) interval = 1;
      if (interval > 12) interval = 12;
      longBreakInterval = interval;
      longIntervalInput.value = interval;

      totalSeconds = durations[currentModeKey];
      if (!isRunning) {
        remainingSeconds = totalSeconds;
      }
      updateTimerDisplay();
      updateProgressVisual();
      updateStatusUI();
    }

    function applyDailyTarget() {
      let target = parseInt(dailyTargetInput.value, 10);
      if (isNaN(target) || target < 1) target = 1;
      if (target > 20) target = 20;
      dailyTarget = target;
      dailyTargetInput.value = target;
      updateSessionDots();
    }

    function updateTaskLabel() {
      const text = taskInput.value.trim();
      taskCurrentLabel.textContent = text
        ? `ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ï¼š${text}`
        : "ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ï¼šæœªè¨­å®š";
    }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
    startPauseBtn.addEventListener("click", () => {
      if (!isRunning) {
        startTimer();
      } else {
        pauseTimer();
      }
    });

    resetBtn.addEventListener("click", () => {
      resetTimer();
    });

    skipBtn.addEventListener("click", () => {
      handleFinish(true);
    });

    modeTabs.forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.mode;
        if (key === currentModeKey) return;
        pauseTimer();
        startPauseBtn.textContent = "â–¶ é–‹å§‹";
        switchMode(key, true);
      });
    });

    applySettingsBtn.addEventListener("click", () => {
      applySettings();
    });

    dailyTargetInput.addEventListener("change", applyDailyTarget);
    dailyTargetInput.addEventListener("blur", applyDailyTarget);

    taskInput.addEventListener("input", updateTaskLabel);

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    window.addEventListener("keydown", (e) => {
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
      if (e.code === "Space") {
        e.preventDefault();
        if (!isRunning) startTimer();
        else pauseTimer();
      } else if (e.key.toLowerCase() === "r") {
        resetTimer();
      }
    });

    // ===== åˆæœŸåŒ– =====
    (function init() {
      updateTimerDisplay();
      updateModeTabs();
      updateProgressVisual();
      updateSessionDots();
      updateStatusUI();
      updateTaskLabel();
      applyDailyTarget();
    })();
  </script>
</body>
</html>
